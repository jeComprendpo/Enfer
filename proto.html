<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Prototype Jouable — Cycle des Brumes</title>
<style>
:root{--bg:#f7f6f2;--ink:#0b0b0b;--accent:#8b5e3c;--danger:#7b1111}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter, system-ui, Arial, sans-serif;background:var(--bg);color:var(--ink)}
.app{display:grid;grid-template-columns:520px 1fr;gap:18px;padding:18px;height:100vh}
.panel{background:rgba(255,255,255,0.7);padding:14px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,0.06)}
.left{display:flex;flex-direction:column;gap:12px}
.h1{font-size:18px;margin:0}
.pent{height:420px;border-radius:10px;position:relative;overflow:hidden}
.svgwrap{width:100%;height:100%;background:linear-gradient(180deg,#fff,#f0efe9)}
.controls{display:flex;gap:8px;flex-wrap:wrap}
.elem{flex:1 1 48%;padding:10px;border-radius:8px;background:rgba(0,0,0,0.03)}
.gauge{height:10px;background:rgba(0,0,0,0.06);border-radius:6px;overflow:hidden;margin-top:8px}
.gfill{height:100%;width:0%}
.btn{padding:8px 10px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
.small{padding:6px 8px;font-size:13px}
.right{display:flex;flex-direction:column;gap:12px}
.hud{display:flex;justify-content:space-between;align-items:center}
.resources{display:flex;gap:8px}
.res{background:rgba(0,0,0,0.04);padding:6px 8px;border-radius:6px}
.log{height:160px;overflow:auto;padding:8px;border-radius:6px;background:rgba(0,0,0,0.03)}
.center{display:flex;gap:12px}
.leftcol{width:420px}
.rightcol{flex:1}
.board{background:linear-gradient(180deg,#fff,#efe8dd);border-radius:8px;padding:10px;height:420px;overflow:auto}
.tile{display:inline-block;width:96px;height:96px;margin:6px;background:#fff;border-radius:8px;box-shadow:0 3px 10px rgba(0,0,0,0.04);vertical-align:top;padding:6px}
.tile h4{margin:0;font-size:13px}
.smallmuted{font-size:12px;color:#444}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45)}
.modal .card{width:760px;height:520px;background:linear-gradient(180deg,#fff,#f6f6f3);border-radius:12px;padding:12px}
.mini-canvas{flex:1;border-radius:8px;background:linear-gradient(180deg,#fff,#efe8dd);box-shadow:inset 0 0 0 1px rgba(0,0,0,0.04)}
.footer{font-size:13px;color:#333;opacity:0.9}
.darkness{position:absolute;inset:0;pointer-events:none;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.25));opacity:0;transition:opacity 1s}
.summary{font-size:13px}
.savebtn{background:#445;}
@media(max-width:980px){.app{grid-template-columns:1fr;grid-auto-rows:auto;padding:10px}.left{order:2}}
</style>
</head>
<body>
<div class="app">
  <div class="panel left">
    <div class="h1">Cycle des Brumes — Prototype jouable</div>
    <div class="pent">
      <div class="svgwrap" id="svgwrap">
        <svg viewBox="0 0 1000 800" preserveAspectRatio="xMidYMid meet" id="mainSvg"></svg>
        <canvas id="inkCanvas" class="" width="1000" height="800" style="position:absolute;inset:0;pointer-events:none"></canvas>
        <div class="darkness" id="darkness"></div>
      </div>
    </div>

    <div class="controls">
      <button class="btn" id="tickBtn">Avancer 1 cycle</button>
      <button class="btn small" id="autoBtn">Auto: OFF</button>
      <button class="btn small" id="ritualBtn">Rituel</button>
      <button class="btn small" id="saveBtn">Sauvegarder</button>
      <button class="btn small" id="loadBtn">Charger</button>
    </div>

    <div class="controls">
      <div class="elem">Bois <div class="gauge"><div class="gfill" id="g-wood"></div></div><div class="smallmuted">Prod: <span id="p-wood">1</span></div></div>
      <div class="elem">Feu <div class="gauge"><div class="gfill" id="g-fire"></div></div><div class="smallmuted">Prod: <span id="p-fire">1</span></div></div>
      <div class="elem">Terre <div class="gauge"><div class="gfill" id="g-earth"></div></div><div class="smallmuted">Prod: <span id="p-earth">1</span></div></div>
      <div class="elem">Métal <div class="gauge"><div class="gfill" id="g-metal"></div></div><div class="smallmuted">Prod: <span id="p-metal">1</span></div></div>
      <div class="elem">Eau <div class="gauge"><div class="gfill" id="g-water"></div></div><div class="smallmuted">Prod: <span id="p-water">1</span></div></div>
    </div>
  </div>

  <div class="panel right">
    <div class="hud">
      <div class="resources">
        <div class="res">Riz: <span id="res-food">0</span></div>
        <div class="res">Bois stock: <span id="res-wood">0</span></div>
        <div class="res">Foi: <span id="res-faith">0</span></div>
        <div class="res">Habitants: <span id="res-pop">0</span></div>
      </div>
      <div class="summary">Corruption: <strong id="corruption">0</strong>% • Saison: <span id="season">Printemps</span> • Cycle: <span id="cycleCount">0</span></div>
    </div>

    <div class="center">
      <div class="leftcol">
        <div class="board" id="board"></div>
      </div>
      <div class="rightcol">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button class="btn small" id="buildFarm">Construire Ferme</button>
          <button class="btn small" id="buildForge">Construire Forge</button>
          <button class="btn small" id="buildWell">Construire Puits</button>
        </div>
        <div class="log" id="log"></div>
        <div style="margin-top:8px" class="footer">Prototype : mécaniques de base (bâtiments, habitants, rituels, événements). Dis-moi quoi ajouter ensuite.</div>
      </div>
    </div>
  </div>
</div>

<!-- RITUAL MODAL -->
<div class="modal" id="modal">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div>Rituel — trace le glyphe</div>
      <div><button class="btn small" id="closeModal">Annuler</button></div>
    </div>
    <div style="display:flex;gap:10px;height:420px">
      <div style="flex:1;display:flex;flex-direction:column">
        <div style="background:rgba(0,0,0,0.03);padding:8px;border-radius:8px;margin-bottom:8px">Glyphe à recopier :</div>
        <svg id="glyphShow" viewBox="0 0 400 240" style="width:100%;height:160px;background:transparent;border-radius:6px"></svg>
        <div style="margin-top:8px">Trace ici :</div>
        <canvas id="drawCanvas" class="mini-canvas" width="680" height="240"></canvas>
      </div>
      <div style="width:260px;display:flex;flex-direction:column;gap:8px">
        <div style="background:rgba(0,0,0,0.03);padding:8px;border-radius:8px">Difficulté: <span id="glyphDiff">Moyen</span></div>
        <div style="background:rgba(0,0,0,0.03);padding:8px;border-radius:8px">Résultat: <span id="ritualResult">—</span></div>
        <div style="display:flex;gap:6px"><button class="btn" id="tryRitual">Valider</button><button class="btn small" id="clearDraw">Effacer</button></div>
        <div style="font-size:13px;color:#555">Réussir réduit la corruption et restaure l'équilibre ; échouer augmente la corruption et provoque un événement.</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- GAME STATE ---------- */
const ELEMENTS = ['wood','fire','earth','metal','water'];
let harmony = {wood:50,fire:50,earth:50,metal:50,water:50};
let production = {wood:1,fire:1,earth:1,metal:1,water:1};
let resources = {food:20,wood:10,faith:5,pop:3};
let corruption = 0; let cycle = 0; let season = 0; const seasons = ['Printemps','Été','Automne','Hiver'];
let auto=false; let buildings = []; // simple building objects
let villagers = [{name:'Ailin',aff:'wood'},{name:'Bo',aff:'earth'},{name:'Mei',aff:'water'}];

/* ---------- UI refs ---------- */n
const logEl = document.getElementById('log');
const board = document.getElementById('board');
const corruptionEl = document.getElementById('corruption');
const resFood = document.getElementById('res-food');
const resWood = document.getElementById('res-wood');
const resFaith = document.getElementById('res-faith');
const resPop = document.getElementById('res-pop');
const cycleCount = document.getElementById('cycleCount');
const seasonEl = document.getElementById('season');

/* ---------- INITIALIZE UI ---------- */
updateAll(); renderBoard(); paintInk(); buildPentagram(); updateGauges();
writeLog('Début de la partie.');

/* ---------- Controls ---------- */
document.getElementById('tickBtn').addEventListener('click',tick);
document.getElementById('autoBtn').addEventListener('click',()=>{auto=!auto;document.getElementById('autoBtn').textContent = auto? 'Auto: ON' : 'Auto: OFF'; if(auto) autoLoop();});
document.getElementById('ritualBtn').addEventListener('click',openRitual);
document.getElementById('buildFarm').addEventListener('click',()=>build('farm'));
document.getElementById('buildForge').addEventListener('click',()=>build('forge'));
document.getElementById('buildWell').addEventListener('click',()=>build('well'));
document.getElementById('saveBtn').addEventListener('click',saveGame);
document.getElementById('loadBtn').addEventListener('click',loadGame);

/* ---------- TICK ---------- */
function tick(){
  cycle++; cycleCount.textContent = cycle; season = Math.floor(cycle/5)%4; seasonEl.textContent = seasons[season];
  // resource gathering influenced by harmony and buildings
  const hFactor = averageHarmony()/50; // around 1
  // base production from villagers
  resources.food += Math.floor(1 * hFactor);
  resources.wood += Math.floor(1 * (harmony.wood/50));
  resources.faith += Math.floor( Math.max(0, (harmony.fire-45)/10) );
  // buildings provide bonuses
  buildings.forEach(b=>{
    if(b.type==='farm'){ resources.food += Math.floor(2 * (harmony.earth/50)); }
    if(b.type==='forge'){ resources.wood -= 1; resources.faith += Math.floor(1 * (harmony.metal/50)); }
    if(b.type==='well'){ resources.food += 1; harmony.water = clamp(harmony.water+2,0,100); }
  });
  // natural influence cycle
  ELEMENTS.forEach(el=>{
    const created = createOrder[el]; harmony[created] = clamp(harmony[created] + (harmony[el]-50)*0.03,0,100);
    const destroyed = destroyOrder[el]; harmony[destroyed] = clamp(harmony[destroyed] - (harmony[el]-50)*0.015,0,100);
  });
  // random event
  if(Math.random()<0.18) randomEvent();
  // corruption increases with imbalance and events
  const imbalance = ELEMENTS.reduce((s,e)=>s+Math.abs(harmony[e]-50),0)/ELEMENTS.length;
  corruption = clamp(corruption + imbalance*0.015,0,100);
  applyVisuals(); updateAll(); writeLog(`Cycle ${cycle} complété. Imbalance ${imbalance.toFixed(2)}.`);
  // check lose
  ELEMENTS.forEach(e=>{ if(harmony[e]<=0||harmony[e]>=100){gameOver(e);} });
}

function autoLoop(){ if(!auto) return; tick(); setTimeout(autoLoop,1200); }

/* ---------- BUILDINGS ---------- */
function build(type){ if(type==='farm'){ buildings.push({id:Date.now(),type:'farm'}); writeLog('Ferme construite.'); }
  if(type==='forge'){ buildings.push({id:Date.now(),type:'forge'}); writeLog('Forge construite.'); }
  if(type==='well'){ buildings.push({id:Date.now(),type:'well'}); writeLog('Puits construit.'); }
  renderBoard(); }

function renderBoard(){ board.innerHTML=''; buildings.forEach(b=>{ const t=document.createElement('div'); t.className='tile'; t.innerHTML=`<h4>${b.type.toUpperCase()}</h4><div class="smallmuted">id:${b.id}</div>`; board.appendChild(t); });
}

/* ---------- EVENTS ---------- */
function randomEvent(){ const r=Math.random(); if(r<0.33){ harmony.water = clamp(harmony.water-8,0,100); writeLog('Événement: Sécheresse légère.'); }
 else if(r<0.66){ harmony.fire = clamp(harmony.fire+8,0,100); writeLog('Événement: Flambée d inspiration (Feu augmente).'); }
 else { writeLog('Événement: Rumeurs étranges au marché.'); }
}

function gameOver(el){ writeLog('Échec: L\'élément '+el+' a basculé. La corruption vous submerge.'); auto=false; document.getElementById('autoBtn').textContent='Auto: OFF'; }

/* ---------- RITUAL MINI-GAME ---------- */
const modal = document.getElementById('modal'); const glyphShow = document.getElementById('glyphShow'); const drawCanvas = document.getElementById('drawCanvas'); const gd = drawCanvas.getContext('2d');
let strokes=[], curStroke=[];

function openRitual(){ modal.style.display='flex'; strokes=[]; curStroke=[]; gd.clearRect(0,0,drawCanvas.width,drawCanvas.height); const gly = generateGlyph(120,60,260,120); renderGlyph(gly); currentGlyph = gly; document.getElementById('ritualResult').textContent='—'; }

function generateGlyph(cx,cy,Rx,Ry){ const pts=[]; for(let i=0;i<5;i++){ const a=-Math.PI/2 + i*2*Math.PI/5; pts.push([cx + Math.cos(a)*Rx* (0.6+Math.random()*0.4), cy + Math.sin(a)*Ry*(0.6+Math.random()*0.4)]); }
 return normalizePath(pts,120); }

function renderGlyph(path){ glyphShow.innerHTML=''; const p=document.createElementNS('http://www.w3.org/2000/svg','path'); p.setAttribute('d', path.map((pt,i)=> (i===0?'M':'L')+' '+pt[0]+' '+pt[1]).join(' ')); p.setAttribute('stroke','#333'); p.setAttribute('stroke-width','4'); p.setAttribute('fill','none'); p.setAttribute('stroke-linecap','round'); glyphShow.appendChild(p);} 

drawCanvas.addEventListener('pointerdown',e=>{ drawing=true; curStroke=[]; draw(e); }); let drawing=false;
window.addEventListener('pointerup',()=>{ if(drawing){strokes.push(curStroke); drawing=false;} });
drawCanvas.addEventListener('pointermove',e=>{ if(drawing) draw(e); });
function draw(e){ const r=drawCanvas.getBoundingClientRect(); const x=(e.clientX-r.left)*(drawCanvas.width/r.width); const y=(e.clientY-r.top)*(drawCanvas.height/r.height); curStroke.push([x,y]); redraw(); }
function redraw(){ gd.clearRect(0,0,drawCanvas.width,drawCanvas.height); gd.lineWidth=6; gd.lineJoin='round'; gd.lineCap='round'; gd.strokeStyle='#000'; strokes.forEach(s=>{ if(s.length){ gd.beginPath(); gd.moveTo(s[0][0],s[0][1]); for(let i=1;i<s.length;i++) gd.lineTo(s[i][0],s[i][1]); gd.stroke(); }}); if(curStroke.length){ gd.beginPath(); gd.moveTo(curStroke[0][0],curStroke[0][1]); for(let i=1;i<curStroke.length;i++) gd.lineTo(curStroke[i][0],curStroke[i][1]); gd.stroke(); } }

document.getElementById('clearDraw').addEventListener('click',()=>{strokes=[];curStroke=[];gd.clearRect(0,0,drawCanvas.width,drawCanvas.height);});
document.getElementById('closeModal').addEventListener('click',()=>{modal.style.display='none'});

let currentGlyph=null;
document.getElementById('tryRitual').addEventListener('click',()=>{ const user = flattenPoints(strokes); if(user.length<10){ document.getElementById('ritualResult').textContent='Trace insuffisante'; return; } const d = comparePaths(currentGlyph,user); const success = d < 0.18; document.getElementById('ritualResult').textContent = success? 'Réussi' : `Échoué (${d.toFixed(3)})`; applyRitual(success); setTimeout(()=>{modal.style.display='none';},700); });

function applyRitual(success){ if(success){ corruption = clamp(corruption - 8,0,100); ELEMENTS.forEach(e=> harmony[e] = harmony[e] + (50 - harmony[e])*0.14; writeLog('Rituel réussi : la brume s éclaircit.'); } else { corruption = clamp(corruption + 10,0,100); // spawn event
 const evt = Math.random()<0.5? 'Visage dans la brume aperçu' : 'Regard hostile sur un villageois'; writeLog('Rituel échoué : '+evt); // destabilize worst
 let worst = ELEMENTS.reduce((a,b)=>Math.abs(harmony[a]-50)>Math.abs(harmony[b]-50)?a:b); harmony[worst] = clamp(harmony[worst] + (Math.random()<0.5?-10:10),0,100);
 } updateAll(); applyVisuals(); }

/* ---------- UTILITIES for path compare ---------- */
function flattenPoints(strokes){ if(!strokes||strokes.length===0) return []; let pts=[]; strokes.forEach(s=>s.forEach(p=>pts.push([p[0]/drawCanvas.width,p[1]/drawCanvas.height]))); return normalizePath(pts,120); }

function normalizePath(pts,target){ if(pts.length===0) return []; // compute distances
 const d=[0]; for(let i=1;i<pts.length;i++){ const dx=pts[i][0]-pts[i-1][0], dy=pts[i][1]-pts[i-1][1]; d.push(d[d.length-1]+Math.hypot(dx,dy)); } const L=d[d.length-1]; if(L===0){ return Array(target).fill(pts[0]); }
 const out=[]; for(let i=0;i<target;i++){ const t = i/(target-1)*L; let j=0; while(j<d.length-1 && d[j+1]<t) j++; const seg = (t-d[j])/(d[j+1]-d[j]||1); const x = pts[j][0] + (pts[j+1][0]-pts[j][0])*seg; const y = pts[j][1] + (pts[j+1][1]-pts[j][1])*seg; out.push([x,y]); } return out; }
function comparePaths(a,b){ if(!a||!b||a.length!==b.length) return 1e9; let s=0; for(let i=0;i<a.length;i++){ const dx=a[i][0]-b[i][0]; const dy=a[i][1]-b[i][1]; s += Math.hypot(dx,dy); } return s/a.length; }

/* ---------- VISUALS ---------- */
const inkCanvas = document.getElementById('inkCanvas'); const inkCtx = inkCanvas.getContext('2d');
function paintInk(){ inkCtx.clearRect(0,0,inkCanvas.width,inkCanvas.height); for(let i=0;i<6;i++){ inkCtx.globalAlpha = 0.06*(i+1); inkCtx.beginPath(); const x = 80+Math.random()*840; const y = 60+Math.random()*680; inkCtx.ellipse(x,y,60+Math.random()*180,40+Math.random()*100,Math.random()*Math.PI,0,Math.PI*2); inkCtx.fillStyle = '#000'; inkCtx.fill(); } }
setInterval(()=>{ paintInk(); },6000);

function buildPentagram(){ const svg = document.getElementById('mainSvg'); svg.innerHTML=''; const W=1000,H=800; const cx=W/2,cy=H/2-40,R=260; const nodes=[]; for(let i=0;i<5;i++){ const ang=-Math.PI/2 + i*2*Math.PI/5; nodes.push([cx + Math.cos(ang)*R, cy + Math.sin(ang)*R]); }
 // lines
 for(let i=0;i<5;i++){ const ni=(i+2)%5; const line = document.createElementNS('http://www.w3.org/2000/svg','line'); line.setAttribute('x1',nodes[i][0]); line.setAttribute('y1',nodes[i][1]); line.setAttribute('x2',nodes[ni][0]); line.setAttribute('y2',nodes[ni][1]); line.setAttribute('stroke','#111'); line.setAttribute('stroke-opacity','0.12'); line.setAttribute('stroke-width','10'); line.setAttribute('stroke-linecap','round'); svg.appendChild(line); }
 // nodes
 const labels=['Bois','Feu','Terre','Métal','Eau']; for(let i=0;i<5;i++){ const g=document.createElementNS('http://www.w3.org/2000/svg','g'); g.setAttribute('transform',`translate(${nodes[i][0]},${nodes[i][1]})`); const circ=document.createElementNS('http://www.w3.org/2000/svg','circle'); circ.setAttribute('r',60); circ.setAttribute('fill','#fff'); circ.setAttribute('stroke','#000'); circ.setAttribute('stroke-opacity','0.06'); circ.setAttribute('stroke-width','4'); g.appendChild(circ); const text=document.createElementNS('http://www.w3.org/2000/svg','text'); text.setAttribute('y','6'); text.setAttribute('text-anchor','middle'); text.setAttribute('font-size','20'); text.setAttribute('fill','#000'); text.setAttribute('opacity','0.8'); text.textContent = labels[i]; g.appendChild(text); svg.appendChild(g); }
}

function updateGauges(){ ELEMENTS.forEach(e=>{ const el=document.getElementById('g-'+e); if(el) el.style.width = harmony[e] + '%'; }); }

function applyVisuals(){ const dark = document.getElementById('darkness'); dark.style.opacity = clamp(corruption/120,0,0.9); // tint nodes when extreme
 const svg = document.getElementById('mainSvg'); // TODO dynamic
}

/* ---------- HELPERS ---------- */
function averageHarmony(){ return ELEMENTS.reduce((s,e)=>s+harmony[e],0)/ELEMENTS.length; }
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function writeLog(t){ const p=document.createElement('div'); p.textContent = '['+new Date().toLocaleTimeString()+'] '+t; logEl.prepend(p); }

/* ---------- SAVE/LOAD ---------- */
function saveGame(){ const save = {harmony,resources,corruption,cycle,buildings,villagers}; localStorage.setItem('cycleSave',JSON.stringify(save)); writeLog('Partie sauvegardée.'); }
function loadGame(){ const s = localStorage.getItem('cycleSave'); if(!s){ writeLog('Aucune sauvegarde trouvée.'); return; } const obj = JSON.parse(s); harmony = obj.harmony; resources = obj.resources; corruption = obj.corruption; cycle = obj.cycle; buildings = obj.buildings||[]; villagers = obj.villagers||[]; updateAll(); renderBoard(); writeLog('Partie chargée.'); }

/* ---------- SIMPLE MATRICES ---------- */
const createOrder = {wood:'fire',fire:'earth',earth:'metal',metal:'water',water:'wood'};
const destroyOrder = {wood:'earth',earth:'water',water:'fire',fire:'metal',metal:'wood'};

/* ---------- MISC UI ---------- */
function updateAll(){ resFood.textContent = resources.food; resWood.textContent = resources.wood; resFaith.textContent = resources.faith; resPop.textContent = villagers.length; corruptionEl.textContent = Math.round(corruption*10)/10; updateGauges(); }

/* ---------- INITIAL CONFIG ---------- */
// set initial harmony
harmony = {wood:55,fire:50,earth:48,metal:50,water:47}; updateGauges(); updateAll();

</script>
</body>
</html>
